require File.dirname(__FILE__) + '/../spec_helper'

describe Sequence do
  it "should add a genbank comment to the beginning of the fasta data if it's missing" do
    fasta_with_comment = <<-ENDSEQ
      >gi|2138274|gb|U76735.1|SCU76735 Saccharomyces cerevisiae putative transcriptional coactivator (ADA1) gene, complete cds
      CTGACACGTTTCTCCCACTGTAACATTAAAAAATCGTCATGATAGCAATGATAATGTGTTAACTACTTAG
      GATAGTCATTATATAGATAACGGAATAAAAAAAGATACGTTCTTATTATCATCACTCAACACGAGCTGTA
    ENDSEQ
    
    fasta_without_comment = "CTGACACGTTTCTCCCACTGTAACATTAAAAAATCGTCATGATAGCAATGATAATGTGTTAACTACTTAG"
        
    s = Sequence.create(:fasta_data => fasta_with_comment)
    s.fasta_data.should == fasta_with_comment
    
    s1 = Sequence.create(:fasta_data => fasta_without_comment)
    s1.fasta_data.should == ">\n" + fasta_without_comment
  end
end

describe 'Sequence.amino_acid?' do
  fixtures :sequences
  
  before(:all) do
    @aa = "MAAGSDLLDEVFFNSEVDEKVVSDLVGSLESQLAASAAHHHHLAPRTPEVRAAAAGALGNHVVSGSPAGA\nAGAGPAAPAEGAPGAAPEPPPAGRARPGGGGPQRPGPPSPRRPLVPAGPAPPAAKLRPPPEGSAGSCAPV\nPAAAAVAAGPEPAPAGPAKPAGPAALAARAGPGPGPGPGPGPGPGPGKPAGPGAAQTLNGSAALLNSHHA\nAAPAVSLVNNGPAALLPLPKPAAPGTVIQTPPFVGAAAPPAPAAPSPPAAPAPAAPAAAPPPPPPAPATL\nARPPGHPAGPPTAAPAVPPPAAAQNGGSAGAAPAPAPAAGGPAGVSGQPGPGAAAAAPAPGVKAESPKRV\nVQAAPPAAQTLAASGPASTAASMVIGPTMQGALPSPAAVPPPAPGTPTGLPKGAAGAVTQSLSRTPTATT\nSGIRATLTPTVLAPRLPQPPQNPTNIQNFQLPPGMVLVRSENGQLLMIPQQALAQMQAQAHAQPQTTMAP\nRPATPTSAPPVQISTVQAPGTPIIARQVTPTTIIKQVSQAQTTVQPSATLQRSPGVQPQLVLGGAAQTAS\nLGTATAVQTGTPQRTVPGATTTSSAATETMENVKKCKNFLSTLIKLASSGKQSTETAANVKELVQNLLDG\nKIEAEDFTSRLYRELNSSPQPYLVPFLKRSLPALRQLTPDSAAFIQQSQQQPPPPTSQATTALTAVVLSS\nSVQRTAGKTAATVTSALQPPVLSLTQPTQVGVGKQGQPTPLVIQQPPKPGALIRPPQVTLTQTPMVALRQ\nPHNRIMLTTPQQIQLNPLQPVPVVKPAVLPGTKALSAVSAQAAAAQKNKLKEPGGGSFRDDDDINDVASM\nAGVNLSEESARILATNSELVGTLTRSCKDETFLLQAPLQRRILEIGKKHGITELHPDVVSYVSHATQQRL\nQNLVEKISETAQQKNFSYKDDDRYEQASDVRAQLKFFEQLDQIEKQRKDEQEREILMRAAKSRSRQEDPE\nQLRLKQKAKEMQQQELAQMRQRDANLTALAAIGPRKKRKVDCPGPGSGAEGSGPGSVVPGSSGVGTPRQF\nTRQRITRVNLRDLIFCLENERETSHSLLLYKAFLK"
    @aa_with_dna_first_line = "CTGACACGTTTCTCCCACTGTAACATTAAAAAATCGTCATGATAGCAATGATAATGTGTTAACTACTTAG\nMAAGSDLLDEVFFNSEVDEKVVSDLVGSLESQLAASAAHHHHLAPRTPEVRAAAAGALGNHVVSGSPAGA\nAGAGPAAPAEGAPGAAPEPPPAGRARPGGGGPQRPGPPSPRRPLVPAGPAPPAAKLRPPPEGSAGSCAPV\nPAAAAVAAGPEPAPAGPAKPAGPAALAARAGPGPGPGPGPGPGPGPGKPAGPGAAQTLNGSAALLNSHHA\nAAPAVSLVNNGPAALLPLPKPAAPGTVIQTPPFVGAAAPPAPAAPSPPAAPAPAAPAAAPPPPPPAPATL\nARPPGHPAGPPTAAPAVPPPAAAQNGGSAGAAPAPAPAAGGPAGVSGQPGPGAAAAAPAPGVKAESPKRV\nVQAAPPAAQTLAASGPASTAASMVIGPTMQGALPSPAAVPPPAPGTPTGLPKGAAGAVTQSLSRTPTATT\nSGIRATLTPTVLAPRLPQPPQNPTNIQNFQLPPGMVLVRSENGQLLMIPQQALAQMQAQAHAQPQTTMAP\nRPATPTSAPPVQISTVQAPGTPIIARQVTPTTIIKQVSQAQTTVQPSATLQRSPGVQPQLVLGGAAQTAS\nLGTATAVQTGTPQRTVPGATTTSSAATETMENVKKCKNFLSTLIKLASSGKQSTETAANVKELVQNLLDG\nKIEAEDFTSRLYRELNSSPQPYLVPFLKRSLPALRQLTPDSAAFIQQSQQQPPPPTSQATTALTAVVLSS\nSVQRTAGKTAATVTSALQPPVLSLTQPTQVGVGKQGQPTPLVIQQPPKPGALIRPPQVTLTQTPMVALRQ\nPHNRIMLTTPQQIQLNPLQPVPVVKPAVLPGTKALSAVSAQAAAAQKNKLKEPGGGSFRDDDDINDVASM\nAGVNLSEESARILATNSELVGTLTRSCKDETFLLQAPLQRRILEIGKKHGITELHPDVVSYVSHATQQRL\nQNLVEKISETAQQKNFSYKDDDRYEQASDVRAQLKFFEQLDQIEKQRKDEQEREILMRAAKSRSRQEDPE\nQLRLKQKAKEMQQQELAQMRQRDANLTALAAIGPRKKRKVDCPGPGSGAEGSGPGSVVPGSSGVGTPRQF\nTRQRITRVNLRDLIFCLENERETSHSLLLYKAFLK"
    @aa_with_comment = ">gi|56405299|sp|O00268.2|TAF4_HUMAN Transcription initiation factor TFIID subunit 4 (TBP-associated factor 4) (Transcription initiation factor TFIID 135 kDa subunit) (TAF(II)135) (TAFII-135) (TAFII135) (TAFII-130) (TAFII130) (RNA polymerase II TBP-associated factor subunit C)\nMAAGSDLLDEVFFNSEVDEKVVSDLVGSLESQLAASAAHHHHLAPRTPEVRAAAAGALGNHVVSGSPAGA\nAGAGPAAPAEGAPGAAPEPPPAGRARPGGGGPQRPGPPSPRRPLVPAGPAPPAAKLRPPPEGSAGSCAPV\nPAAAAVAAGPEPAPAGPAKPAGPAALAARAGPGPGPGPGPGPGPGPGKPAGPGAAQTLNGSAALLNSHHA\nAAPAVSLVNNGPAALLPLPKPAAPGTVIQTPPFVGAAAPPAPAAPSPPAAPAPAAPAAAPPPPPPAPATL\nARPPGHPAGPPTAAPAVPPPAAAQNGGSAGAAPAPAPAAGGPAGVSGQPGPGAAAAAPAPGVKAESPKRV\nVQAAPPAAQTLAASGPASTAASMVIGPTMQGALPSPAAVPPPAPGTPTGLPKGAAGAVTQSLSRTPTATT\nSGIRATLTPTVLAPRLPQPPQNPTNIQNFQLPPGMVLVRSENGQLLMIPQQALAQMQAQAHAQPQTTMAP\nRPATPTSAPPVQISTVQAPGTPIIARQVTPTTIIKQVSQAQTTVQPSATLQRSPGVQPQLVLGGAAQTAS\nLGTATAVQTGTPQRTVPGATTTSSAATETMENVKKCKNFLSTLIKLASSGKQSTETAANVKELVQNLLDG\nKIEAEDFTSRLYRELNSSPQPYLVPFLKRSLPALRQLTPDSAAFIQQSQQQPPPPTSQATTALTAVVLSS\nSVQRTAGKTAATVTSALQPPVLSLTQPTQVGVGKQGQPTPLVIQQPPKPGALIRPPQVTLTQTPMVALRQ\nPHNRIMLTTPQQIQLNPLQPVPVVKPAVLPGTKALSAVSAQAAAAQKNKLKEPGGGSFRDDDDINDVASM\nAGVNLSEESARILATNSELVGTLTRSCKDETFLLQAPLQRRILEIGKKHGITELHPDVVSYVSHATQQRL\nQNLVEKISETAQQKNFSYKDDDRYEQASDVRAQLKFFEQLDQIEKQRKDEQEREILMRAAKSRSRQEDPE\nQLRLKQKAKEMQQQELAQMRQRDANLTALAAIGPRKKRKVDCPGPGSGAEGSGPGSVVPGSSGVGTPRQF\nTRQRITRVNLRDLIFCLENERETSHSLLLYKAFLK"

    @dna = "CTGACACGTTTCTCCCACTGTAACATTAAAAAATCGTCATGATAGCAATGATAATGTGTTAACTACTTAG\nGATAGTCATTATATAGATAACGGAATAAAAAAAGATACGTTCTTATTATCATCACTCAACACGAGCTGTA\nATTCCCGCCCATTTTTTCTTCATTATCAGGTTGCGATTTTGAACAAAAAAAGTGAAACTTGAAGTTACGA\nTGTGACATAAATTTGTTAAAATAAAAAAGATAAAATTCAGGATAGAAGTAGGTTCAAATTGTCTTCTGTC\nTACTTGTGCCTTGAAGCATCGACTTACAACAGATTAACAAAGTATCGTTGCTCTTTTCATTCGTCTGTTC\nGTTATCATCATTGGATAGGGCTTACTTTCTCGCACGTGATTTTTCCCACAGTATAAATTTTGAGCTATAA\nGTGGTAATAAAAATTCAATAAAAATATAGGGAAAACAAGCCCGTAGTTTTGATTTCTTCTATCATGTCAG\nCTATACAATCGCCAGCACCTAAACCTCTGCAGCCAACTTATCCAGCTGCTTCGCCAGCTTCCACGAATGC\nATATATGAAGCCGGGCCTAATTGGTAGTCCTGCCGTCAGTAATCATACCGAGCCTAACAATGGTAACAAT\nGAAACTGCGGAGCCTCAGGGACCAAATCAGAGAATTGATTTGGGTGCCATGATCGAAGAATTAACCTCAC\nTATTGGGAAAAGAAAGCTGGACGAAATATGCTCAGATCATCAGTCTTTTCATTTTAGGGAAGTTATCCAG\nAAAGGAACTTTCTAATGAATTAGAGCTGGTATTTTCACCAAGCGCTGCAAGCTTAGAAAAATCAAATACA\nAATCATCACCATAGTTTAGTACGACTTCATAACCAACTTTTATTAGGGATTTTTGCTAATTCATTACGTG\nAAAACCCTCTTGGGAGAAACGGTAATGAGAGTTCTTGGGGATTTGGCAATGGAAGCAACAATCCAAACAA\nTAAACTAAAAAGAATCAATAAGCATAACTCTCAAATTGAAGTCTATAAAAAAATTGTCATGTCGTTACCT\nCTAAATGATCGAAATAGACTTAAAATGATCACGAAAGAGGCCGGCAAAAGAGGCTTCATTTTTTGCTCTG\nTATTTCAAGCCAGATTAAATAATATACCCAAAATTCCCATTGTAACCAATCCAGAAAGTTTGAAGCGTGT\nCAAGAGCAATAATTTAAAAACGCCGCTGGAATGGTCACAAGATATAATGAATGGATTCAACGTTCCTTTA\nGCGAGCGAAAGCCATTCTTTACCAGACACGGATTCGTTTTACTTAAGAATGGTTGGTATAGCAAGAGAAC\nATGGGTTAGTCGGCACAGTGGACGCACGTTGCGTAGAGCTTATATCATTGGCCCTAGATCAATATCTAAA\nAAATATAATAGAGTTTACTATTGATACAGTTCGTTATAGAAGGAAGAAATATTCAGATTATTATGATTTG\nAATGAGAGTGGGCTTTATAAATCCGTATCAGAAATGGCTGCTGATAAACGCGATGCCAAAATTAAGCAGT\nTAGATGATGATAAAAATGAGGATGAATGTGCCGATGAAGCCAAAAGTATTAATAACGGCAATAACAGTAG\nCAAGGACGATATTGGCGACATATCAATGAGCAGCATTACAAAGGCTGGCGAAGCAGTTAATGAGGAGTTA\nCATGAAAACAGAACGATATCATTAACGAATGAAGACATATATGATTCGTTATCTATATTTCCGAATTTGG\nTTGAACCTTCAGGTTCATACTATGCGTTAACTAATTTAGGGCTAGTTAACGATGATGAACTAGTAGATAT\nGAAGAGCAATATTGACGACTTGCCGGACTTCTTAAATGAAAAGCCGACTTTCACGCCTTTGGATGAAAGA\nAACGTTGGTACAAGGCATGAATTAAATTGGTTAATTAAAGGAATCTTAACGGAAGATTGATGTATAAAAA\nGTTTGCGTATGCGGTATGTTGTAATTATATTGAAAGATTATAAACCTTATTTGTTTCATATCTAAATGGC\nTGTGTTAAGAAAGACGATAATGTGACGGAGCTTAAGTGAGCTTTTTCTTTCTTTTACAAAGTTGTGTTTG\nAACTTCTTCAGAAATCGTTAATAATTTATTGACATTTTTTGAATCGTTCAAGTTTAGCAAGAAAAAGCAT\nTTAGTATCAGAAATTAGTTTTTTCAGAACAAGTGCAATAGGGGTCTCGCATGATTCCTTCTTAAAGATGC\nTTTTATCAAACTGTTCAATGGACTTCAGATTATTTAACTCGATAAAATAAAAGTCCACCGGTACGGGGTC\nATTGTTGCCATCGCTTTTTGAATCTCGAGGAAAAAACTGCACCTTGATTATACCCATCCCAGAATGAGGT\nAAATTTGGGTGTTCATCACAACTAAAATTTAAGGGCAAATCAACGAGTCCATTTTCTATGATGACAAGTT\nTGGAATCCAAAGAAATTGAGTGTTTTTCAAATTTCAACTTTATGCTATCTTTATCATTGTGGAATAATCC\nAAGAGCATGTCCTGAGAAAATTCGTCATCTGATAAAAATACAAACTGTAAGGTGATCCACAGGACGGGTG\nTGGTCGCCATGATCGCGTAGTCGATAGTGGCTCCAAGTAGCGAAGCGAGCAGGACTGGGCGGCGGCCAAA\nGCGGTCGGACAGTGCTCCGAGAACGGGTGCGCATAGAAATTGCATCAACGCATAT"
    @dna_with_comment = ">LFQEPI\nCTGACACGTTTCTCCCACTGTAACATTAAAAAATCGTCATGATAGCAATGATAATGTGTTAACTACTTAG\nGATAGTCATTATATAGATAACGGAATAAAAAAAGATACGTTCTTATTATCATCACTCAACACGAGCTGTA\nATTCCCGCCCATTTTTTCTTCATTATCAGGTTGCGATTTTGAACAAAAAAAGTGAAACTTGAAGTTACGA\nTGTGACATAAATTTGTTAAAATAAAAAAGATAAAATTCAGGATAGAAGTAGGTTCAAATTGTCTTCTGTC\nTACTTGTGCCTTGAAGCATCGACTTACAACAGATTAACAAAGTATCGTTGCTCTTTTCATTCGTCTGTTC\nGTTATCATCATTGGATAGGGCTTACTTTCTCGCACGTGATTTTTCCCACAGTATAAATTTTGAGCTATAA\nGTGGTAATAAAAATTCAATAAAAATATAGGGAAAACAAGCCCGTAGTTTTGATTTCTTCTATCATGTCAG\nCTATACAATCGCCAGCACCTAAACCTCTGCAGCCAACTTATCCAGCTGCTTCGCCAGCTTCCACGAATGC\nATATATGAAGCCGGGCCTAATTGGTAGTCCTGCCGTCAGTAATCATACCGAGCCTAACAATGGTAACAAT\nGAAACTGCGGAGCCTCAGGGACCAAATCAGAGAATTGATTTGGGTGCCATGATCGAAGAATTAACCTCAC\nTATTGGGAAAAGAAAGCTGGACGAAATATGCTCAGATCATCAGTCTTTTCATTTTAGGGAAGTTATCCAG\nAAAGGAACTTTCTAATGAATTAGAGCTGGTATTTTCACCAAGCGCTGCAAGCTTAGAAAAATCAAATACA\nAATCATCACCATAGTTTAGTACGACTTCATAACCAACTTTTATTAGGGATTTTTGCTAATTCATTACGTG\nAAAACCCTCTTGGGAGAAACGGTAATGAGAGTTCTTGGGGATTTGGCAATGGAAGCAACAATCCAAACAA\nTAAACTAAAAAGAATCAATAAGCATAACTCTCAAATTGAAGTCTATAAAAAAATTGTCATGTCGTTACCT\nCTAAATGATCGAAATAGACTTAAAATGATCACGAAAGAGGCCGGCAAAAGAGGCTTCATTTTTTGCTCTG\nTATTTCAAGCCAGATTAAATAATATACCCAAAATTCCCATTGTAACCAATCCAGAAAGTTTGAAGCGTGT\nCAAGAGCAATAATTTAAAAACGCCGCTGGAATGGTCACAAGATATAATGAATGGATTCAACGTTCCTTTA\nGCGAGCGAAAGCCATTCTTTACCAGACACGGATTCGTTTTACTTAAGAATGGTTGGTATAGCAAGAGAAC\nATGGGTTAGTCGGCACAGTGGACGCACGTTGCGTAGAGCTTATATCATTGGCCCTAGATCAATATCTAAA\nAAATATAATAGAGTTTACTATTGATACAGTTCGTTATAGAAGGAAGAAATATTCAGATTATTATGATTTG\nAATGAGAGTGGGCTTTATAAATCCGTATCAGAAATGGCTGCTGATAAACGCGATGCCAAAATTAAGCAGT\nTAGATGATGATAAAAATGAGGATGAATGTGCCGATGAAGCCAAAAGTATTAATAACGGCAATAACAGTAG\nCAAGGACGATATTGGCGACATATCAATGAGCAGCATTACAAAGGCTGGCGAAGCAGTTAATGAGGAGTTA\nCATGAAAACAGAACGATATCATTAACGAATGAAGACATATATGATTCGTTATCTATATTTCCGAATTTGG\nTTGAACCTTCAGGTTCATACTATGCGTTAACTAATTTAGGGCTAGTTAACGATGATGAACTAGTAGATAT\nGAAGAGCAATATTGACGACTTGCCGGACTTCTTAAATGAAAAGCCGACTTTCACGCCTTTGGATGAAAGA\nAACGTTGGTACAAGGCATGAATTAAATTGGTTAATTAAAGGAATCTTAACGGAAGATTGATGTATAAAAA\nGTTTGCGTATGCGGTATGTTGTAATTATATTGAAAGATTATAAACCTTATTTGTTTCATATCTAAATGGC\nTGTGTTAAGAAAGACGATAATGTGACGGAGCTTAAGTGAGCTTTTTCTTTCTTTTACAAAGTTGTGTTTG\nAACTTCTTCAGAAATCGTTAATAATTTATTGACATTTTTTGAATCGTTCAAGTTTAGCAAGAAAAAGCAT\nTTAGTATCAGAAATTAGTTTTTTCAGAACAAGTGCAATAGGGGTCTCGCATGATTCCTTCTTAAAGATGC\nTTTTATCAAACTGTTCAATGGACTTCAGATTATTTAACTCGATAAAATAAAAGTCCACCGGTACGGGGTC\nATTGTTGCCATCGCTTTTTGAATCTCGAGGAAAAAACTGCACCTTGATTATACCCATCCCAGAATGAGGT\nAAATTTGGGTGTTCATCACAACTAAAATTTAAGGGCAAATCAACGAGTCCATTTTCTATGATGACAAGTT\nTGGAATCCAAAGAAATTGAGTGTTTTTCAAATTTCAACTTTATGCTATCTTTATCATTGTGGAATAATCC\nAAGAGCATGTCCTGAGAAAATTCGTCATCTGATAAAAATACAAACTGTAAGGTGATCCACAGGACGGGTG\nTGGTCGCCATGATCGCGTAGTCGATAGTGGCTCCAAGTAGCGAAGCGAGCAGGACTGGGCGGCGGCCAAA\nGCGGTCGGACAGTGCTCCGAGAACGGGTGCGCATAGAAATTGCATCAACGCATAT"
  end
  
  it "should identify an Amino Acid" do
    Sequence.amino_acid?(@aa).should be_true
    Sequence.amino_acid?(@aa_with_dna_first_line).should be_true
    Sequence.amino_acid?(@aa_with_comment).should be_true
  end
  
  it "should identify a DNA sequence" do
    Sequence.amino_acid?(@dna).should be_false
  end
  
  it "should ignore comment lines" do
    # The comment line in the dna_with_comment contains all the unique amino letters. They should be ignored.
    Sequence.amino_acid?(@dna_with_comment).should be_false
  end
  
  it  "should handle upper and lower case sequences" do
    Sequence.amino_acid?(@aa.downcase).should be_true
    Sequence.amino_acid?(@aa_with_dna_first_line.downcase).should be_true
    Sequence.amino_acid?(@aa_with_comment.downcase).should be_true
  end
  
  it  "should work from the instance method too" do
    sequences(:app).amino_acid?.should be_false
  end
end

describe 'Sequence.extract_gi_from_genbank_comment' do
  
  before(:each) do
    @query = Sequence.new
  end
  
  it "should return the GI from a sequence with a valid Genbank comment" do
    fasta_data = <<-ENDSEQUENCE
      >gi|2138274|gb|U76735.1|SCU76735 Saccharomyces cerevisiae putative transcriptional coactivator (ADA1) gene, complete cds
      CTGACACGTTTCTCCCACTGTAACATTAAAAAATCGTCATGATAGCAATGATAATGTGTTAACTACTTAG
      GATAGTCATTATATAGATAACGGAATAAAAAAAGATACGTTCTTATTATCATCACTCAACACGAGCTGTA
    ENDSEQUENCE
    
    Sequence.extract_gi_from_genbank_comment(fasta_data).should == '2138274'
  end
  
  it "should return the GI from APP from Homo Sapiens" do
    fasta_data = ">gi|41406056|ref|nm_201414.1| homo sapiens amyloid beta (a4) precursor protein (peptidase nexin-ii, alzheimer disease) (app), transcript variant 3, mrna\r\ngctgactcgcctggctctgagccccgccgccgcgctcgggctccgtcagtttcctcggcagcggtaggcg\r\nagagcacgcggaggagcgtgcgcgggggccccgggagacggcggcggtggcggcgcgggcagagcaagga"
    Sequence.extract_gi_from_genbank_comment(fasta_data).should == '41406056'
  end
  
  it "should return nil if given an invalid comment" do
    fasta_data = <<-ENDSEQUENCE
      >test_sequence_1
      CTGACACGTTTCTCCCACTGTAACATTAAAAAATCGTCATGATAGCAATGATAATGTGTTAACTACTTAG
      GATAGTCATTATATAGATAACGGAATAAAAAAAGATACGTTCTTATTATCATCACTCAACACGAGCTGTA
    ENDSEQUENCE
    
    Sequence.extract_gi_from_genbank_comment(fasta_data).should be_nil
  end
end